# staging_schema.py - CORRECTED SCHEMAS
from pyspark.sql.types import *

# CORRECTED: card_revenue is a single object, not an array
card_revenue_schema = StructType([
    StructField("end_date", StringType(), True),
    StructField("date_accessible", StringType(), True),  # MISSING FIELD ADDED
    StructField("1m", StructType([
        StructField("start_date", StringType(), True),
        StructField("average_monthly_amount", DoubleType(), True)
    ]), True),
    StructField("3m", StructType([
        StructField("start_date", StringType(), True),
        StructField("average_monthly_amount", DoubleType(), True)
    ]), True),
    StructField("12m", StructType([
        StructField("start_date", StringType(), True),
        StructField("average_monthly_amount", DoubleType(), True)
    ]), True)
])

# CORRECTED: card_transactions_stability is a single object, not an array
card_transactions_stability_schema = StructType([
    StructField("end_date", StringType(), True),
    StructField("date_accessible", StringType(), True),
    StructField("1m", StructType([
        StructField("start_date", StringType(), True),
        StructField("days_present", IntegerType(), True),
        StructField("weeks_present", IntegerType(), True),
        StructField("months_present", IntegerType(), True),
        StructField("daily_coverage_ratio", DoubleType(), True),
        StructField("weekly_coverage_ratio", DoubleType(), True),
        StructField("monthly_coverage_ratio", DoubleType(), True)
    ]), True),
    StructField("3m", StructType([
        StructField("start_date", StringType(), True),
        StructField("days_present", IntegerType(), True),
        StructField("weeks_present", IntegerType(), True),
        StructField("months_present", IntegerType(), True),
        StructField("daily_coverage_ratio", DoubleType(), True),
        StructField("weekly_coverage_ratio", DoubleType(), True),
        StructField("monthly_coverage_ratio", DoubleType(), True)
    ]), True),
    StructField("12m", StructType([
        StructField("start_date", StringType(), True),
        StructField("days_present", IntegerType(), True),
        StructField("weeks_present", IntegerType(), True),
        StructField("months_present", IntegerType(), True),
        StructField("daily_coverage_ratio", DoubleType(), True),
        StructField("weekly_coverage_ratio", DoubleType(), True),
        StructField("monthly_coverage_ratio", DoubleType(), True)
    ]), True)
])

# CORRECT: associated_people is an array
associated_people_schema = ArrayType(StructType([
    StructField("name", StringType(), True),
    StructField("titles", ArrayType(StringType()), True)
]))

# CORRECTED: industries is a single object, not an array
industries_schema = StructType([
    StructField("classification_type", StringType(), True),
    StructField("classification_code", StringType(), True),
    StructField("classification_description", StringType(), True)
])

# CORRECTED: technologies is a single object, not an array  
technologies_schema = StructType([
    StructField("vendor_name", StringType(), True),
    StructField("category", StringType(), True)
])

# Configuration mapping
JSON_FIELD_CONFIGS = {
    'card_revenue': {
        'schema': card_revenue_schema,
        'flatten_type': 'struct',  # Single nested object
        'prefix': 'card_revenue'
    },
    'card_transactions_stability': {
        'schema': card_transactions_stability_schema,
        'flatten_type': 'struct',  # Single nested object
        'prefix': 'card_transactions_stability'
    },
    'associated_people': {
        'schema': associated_people_schema,
        'flatten_type': 'array_double_explode',  # Array with nested array (titles)
        'prefix': 'associated_people'
    },
    'industries': {
        'schema': industries_schema,
        'flatten_type': 'struct',  # Single nested object
        'prefix': 'industries'
    },
    'technologies': {
        'schema': technologies_schema,
        'flatten_type': 'struct',  # Single nested object
        'prefix': 'technologies'
    }
}

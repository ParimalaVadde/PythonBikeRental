# Before flattening, convert string arrays to actual arrays
transformed_json_df = transformed_json_df.withColumn(
    "registered_agents",
    F.when(
        F.col("registered_agents").isNotNull() & (F.col("registered_agents") != "[]"),
        F.from_json(F.col("registered_agents"), ArrayType(StringType()))
    ).otherwise(F.array())  # Use empty array instead of null
)

this is my jira user story heading

SDS Data Processing : Implement New PFD Fields & Fix Staging Data Load Issues

Description:
Enhance the SDS data pipeline to process additional PFD fields while addressing existing issues in staging data load. This includes updating field mappings, standardizing data formats, and resolving entity relationship inconsistencies to improve data quality and completeness.

acceptance criteria:
All new PFD fields correctly integrated
Data format issues resolved
Entity relationship problems fixed
Perform test with sample data
No regression in existing functionality


Sub-Tasks
Create Sub-Task

Options
1.
Integrate New PFD Fields into Data Pipeline	Sub-task	In Progress	

give me crisp comments to add
these are my analysis for new column. add liner for each col . keep it short n crisp. anlysis is completed

new file shared have some descripencies

so will be implemented these changes in next sprint

1) task_id

source Columns(anlysis_pfd)   |   tgt_column   |     comments 
task_id                        analysis_task_id     Create a new column `analysis_task_id` in                                                  `business_entity_spend_analysis` table

  i)DDL changes 
    column addition "analysis_task_id" to "sds_staging.business_entity_spend_analysis" 

  ii)changes in stagging_schema.py 

     spend_analysis = ["stg_business_entity_id", "stg_payor_business_entity_id", "analysis_task_id", "analysis_conducted_dt", "analysis_external_reference_id", "analysis_stage", "count_of_invoices", "payment_terms", "count_of_payments", "sum_of_payments", "period_start_date", "period_end_date", "payment_ccy", "actual_days_payment_outstanding", "payment_mode", "payment_term_days", "payment_terms_discount_ind", "payment_terms_discount_rate", "payment_terms_discount_days"]

  iii)mapping file changes , a column addition 

     analysis_pfd	 task_id	business_entity_spend_analysis	analysis_task_id

##########################################################################################

2) sds_upload_id

	Map to `business_entity_spend_analysis.analysis_external_reference_id` (replacing user_request_id)

	i) DDL changes
		rename column from "user_request_id" to "sds_upload_id" in "sds_staging.business_entity_spend_analysis" 


	ii) mapping file changes.
		change from
"analysis_pfd	user_request_id	business_entity_spend_analysis	analysis_external_reference_id"
to
"analysis_pfd	sds_upload_id	business_entity_spend_analysis	analysis_external_reference_id"

#############################################################################################

3) client_name

ii) mapping file changes.
		change from
"analysis_pfd	stg_buying_entity	business_entity_spend_analysis	stg_payor_business_entity_id"
to
"analysis_pfd	client_name	business_entity_spend_analysis	stg_payor_business_entity_id"
 

#############################################################################################

4)supplier_ecid

Map to `business_entity_identifiers.identifier_value` with a new `identifier_type`


changes in pfd_staging.py and stagging_schema.py

need to add it in types table in main schema

##############################################################################################

5)Map to `business_entity_characteristics` with a new `characteristic_type` for below columns
ind_decline
stp_partnershiplist

  i) stagging_schema.py changes
  
  characteristics = ["stg_business_entity_id", "scf_industry_sector_dso_25", "scf_industry_sector_dso_50", "scf_industry_sector_dso_75", "scf_industry_group_dso_25", "scf_industry_group_dso_50", "scf_industry_group_dso_75", "Moody", "SP", "credit_revolver_rate", "cost_of_goods_sold", "vc_campaigned_previously", "vc_acceptance_tier_legacy", "vc_acceptance_tier_model", "vc_acceptance_tier_userdefined", "vc_campaign_count", "vc_campaign_accepts", "stp_ind_decline", "stp_partnershiplist"]
  
  
need to add it in types table in main schema

##############################################################################################

6) Map to `business_entity_receivables_attribute` with a new `attribute_type` for below column  

throughput_usd
avg_spread
avg_payment_terms
rate_proposed
rate_offered
esg_discount


i) changes in stagging_schema.py


payment_profile = ["stg_business_entity_id","average_vendor_dso", "average_vendor_dpo", "average_vendor_dio", "enrolled_scf_supplier", "enrolled_vc_supplier", "vc_concierge", "virtual_card_vcn", "spend_on_jpmc_vc", "vc_enrollment_duration_years","vc_buyercount", "vc_interchange_amt", "cms_enrolled", "cms_subacct_enrolled", "businessbank_enrolled", "vcn_payment_accepted", "product_segmentation_applicable", "jpmc_cc_payment_accepted", "jpmc_cc_spend", "jpmc_cc_enrolled_years", "jpmc_cc_buyer_count", "has_online_payments", "scf_throughput_usd", "scf_avg_spread", "scf_avg_payment_terms", "scf_rate_proposed", "scf_rate_offered", "scf_esg_discount"]

 # same as above, excluding stg_business_entity_id
payment_profile_columns = [
    "average_vendor_dso", "average_vendor_dpo", "average_vendor_dio", "enrolled_scf_supplier",
    "enrolled_vc_supplier", "vc_concierge", "virtual_card_vcn", "spend_on_jpmc_vc",
    "vc_enrollment_duration_years", "vc_buyercount", "vc_interchange_amt", "cms_enrolled",
    "cms_subacct_enrolled", "businessbank_enrolled", "vcn_payment_accepted",
    "product_segmentation_applicable", "jpmc_cc_payment_accepted", "jpmc_cc_spend",
    "jpmc_cc_enrolled_years", "jpmc_cc_buyer_count", "has_online_payments", "scf_throughput_usd", "scf_avg_spread", "scf_avg_payment_terms", "scf_rate_proposed", "scf_rate_offered", "scf_esg_discount"
]


ii) changes in mapping file. addition of these columns in mapping file.

analysis_pfd	throughput_usd	business_entity_payment_profile_attribute	scf_throughput_usd
analysis_pfd	avg_spread	business_entity_payment_profile_attribute	scf_avg_spread
analysis_pfd	avg_payment_terms	business_entity_payment_profile_attribute	scf_avg_payment_terms
analysis_pfd	rate_proposed	business_entity_payment_profile_attribute	scf_rate_proposed
analysis_pfd	rate_offered	business_entity_payment_profile_attribute	scf_rate_offered
analysis_pfd	esg_discount	business_entity_payment_profile_attribute	scf_esg_discount



need to add it in types table in main schema


2.
Fix Data Format Issues in Staging Glue Job	Sub-task	In Progress	
Description:
Address data format standardization issues in the staging Glue job to ensure consistent data processing.

Modified registered_agents processing to maintain semicolon-separated format in characteristics table
Updated product segmentation data handling to maintain semicolon-separated format in receivables_attribute table.


give me crisp comments to add

staging:
	- characteristics (registered_agents has to be ; seperated) -- fixed
	- receivables_attribute (Prod seg ; seperated)  == we are pivoting the df not exploding sno changes required -- currently receivables_attribute is string in current source file , can't be exploded. need to check source team on data type of this column

3.
Fix Entity Relationship Handling	Sub-task	In Progress	

description:
Eliminated duplicate records for entity and relationships in identifiers table
Updated contact_id reference handling in relationship table
Implemented correct date format handling for start and end dates in spend_analysis
Added logic to create new contacts when vendor_contact_name is present in relationships
Validation report confirming all relationship integrity issues have been resolved

give me crisp comments to add
-vendor_contact_name which is in the PFD file should be the contact name in the relationship table --- fixed
	-relationships (contact_id in relationship table needs to be changed) -- fixed
	- spend_analysis (start and end date has to be mapped) -- fixed 
- identifiers (double records for entity and relationships, shouldn't display duplicate records for business_entity and relationship) -- fixed, if particular identifier type mapped to 'relationship' related identifier source then same identifier shouldn't be mapped to 'business_entity' related identifier source -- this is fixed by making changes in code

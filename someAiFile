-- select * from sds_staging.business_entity_characteristics order by stg_business_entity_id

-- select * from sds_main.physical_address

-- select * from sds_staging.business_entity

-- select * from sds_staging.business_entity_details

Loaded sample data from landing to staging using SQL queries for the following tables:

sds_staging.business_entity_characteristics
sds_main.physical_address
sds_staging.business_entity
sds_staging.business_entity_details



CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

INSERT INTO sds_staging.business_entity_characteristics
(
    characteristics_id,
    stg_business_entity_id,
    characteristics_type,
    characteristic_value,
    is_active,
    last_updated_by,
    last_updated_date,
    created_by,
    created_date,
    business_validation_reason
)
WITH base_data AS (
    SELECT DISTINCT
        CAST(vendor_name_cleaned AS VARCHAR) AS vendor_name_cleaned,
        CAST(vendor_email AS VARCHAR) AS vendor_email,
        CAST(vendor_government_id AS VARCHAR) AS vendor_government_id,
        CAST(vendor_address_ln_1 AS VARCHAR) AS vendor_address_ln_1,
        CAST(industry_sector_dso_25 AS VARCHAR) AS industry_sector_dso_25,
        CAST(industry_sector_dso_50 AS VARCHAR) AS industry_sector_dso_50,
        CAST(industry_sector_dso_75 AS VARCHAR) AS industry_sector_dso_75,
        CAST(industry_group_dso_25 AS VARCHAR) AS industry_group_dso_25,
        CAST(industry_group_dso_50 AS VARCHAR) AS industry_group_dso_50,
        CAST(industry_group_dso_75 AS VARCHAR) AS industry_group_dso_75,
        CAST(vendor_credit_rating_moody AS VARCHAR) AS vendor_credit_rating_moody,
        CAST(vendor_credit_rating_sp AS VARCHAR) AS vendor_credit_rating_sp,
        CAST(vendor_credit_revolver_rate AS VARCHAR) AS vendor_credit_revolver_rate,
        CAST(vendor_cogs AS VARCHAR) AS vendor_cogs,
        CAST(ind_vc_campaign AS VARCHAR) AS ind_vc_campaign,
        CAST(virtualcard_accpetance_tier_legacy AS VARCHAR) AS virtualcard_accpetance_tier_legacy,
        CAST(virtualcard_accpetance_tier_model AS VARCHAR) AS virtualcard_accpetance_tier_model,
        CAST(virtualcard_accpetance_tier_userdefined AS VARCHAR) AS virtualcard_accpetance_tier_userdefined,
        CAST(ind_virtual_card_campaign_count AS VARCHAR) AS ind_virtual_card_campaign_count,
        CAST(vc_campaign_accepts AS VARCHAR) AS vc_campaign_accepts,
        CAST(registered_agents AS VARCHAR) AS registered_agents
    FROM sds_landing.analysis_pfd
),
entity_hash AS (
    SELECT 
        bd.*,
        encode(digest(CONCAT_WS('-', 
            COALESCE(bd.vendor_name_cleaned, ''), 
            COALESCE(bd.vendor_email, ''), 
            COALESCE(bd.vendor_government_id, ''),
            COALESCE(bd.vendor_address_ln_1, '')
        ), 'sha256'), 'hex') AS entity_hash_value
    FROM base_data bd
),
entity_id_mapping AS (
    SELECT
        eh.*,
        substring(entity_hash_value, 1, 8) || '-' ||
        substring(entity_hash_value, 9, 4) || '-' ||
        substring(entity_hash_value, 13, 4) || '-' ||
        substring(entity_hash_value, 17, 4) || '-' ||
        substring(entity_hash_value, 21, 12) AS stg_business_entity_id
    FROM entity_hash eh
),
-- Add the buying entities CTE
buying_entities AS (
    SELECT DISTINCT
        CAST(buying_entity AS VARCHAR) AS buying_entity_name,
        encode(digest(COALESCE(buying_entity, ''), 'sha256'), 'hex') AS hash_value
    FROM sds_landing.analysis_pfd
    WHERE buying_entity IS NOT NULL
),
-- Add the JP Morgan Chase constant entity CTE
jpmc_entity AS (
    SELECT
        'JP Morgan Chase Bank N.A.' AS business_entity_name,
        encode(digest('JP Morgan Chase Bank N.A.', 'sha256'), 'hex') AS hash_value
),
-- Add mappings for buying entities
buying_entity_mappings AS (
    SELECT
        buying_entity_name,
        hash_value,
        substring(hash_value, 1, 8) || '-' ||
        substring(hash_value, 9, 4) || '-' ||
        substring(hash_value, 13, 4) || '-' ||
        substring(hash_value, 17, 4) || '-' ||
        substring(hash_value, 21, 12) AS stg_business_entity_id
    FROM buying_entities
),
-- Add mapping for JPMC
jpmc_mapping AS (
    SELECT
        business_entity_name,
        hash_value,
        substring(hash_value, 1, 8) || '-' ||
        substring(hash_value, 9, 4) || '-' ||
        substring(hash_value, 13, 4) || '-' ||
        substring(hash_value, 17, 4) || '-' ||
        substring(hash_value, 21, 12) AS stg_business_entity_id
    FROM jpmc_entity
)

-- 1) Industry sector DSO 25
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'industry_sector_dso_25' AS characteristics_type,
    industry_sector_dso_25 AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE industry_sector_dso_25 IS NOT NULL

UNION ALL

-- 2) Industry sector DSO 50
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'industry_sector_dso_50' AS characteristics_type,
    industry_sector_dso_50 AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE industry_sector_dso_50 IS NOT NULL

UNION ALL

-- 3) Industry sector DSO 75
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'industry_sector_dso_75' AS characteristics_type,
    industry_sector_dso_75 AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE industry_sector_dso_75 IS NOT NULL

UNION ALL

-- 4) Industry group DSO 25
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'industry_group_dso_25' AS characteristics_type,
    industry_group_dso_25 AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE industry_group_dso_25 IS NOT NULL

UNION ALL

-- 5) Industry group DSO 50
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'industry_group_dso_50' AS characteristics_type,
    industry_group_dso_50 AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE industry_group_dso_50 IS NOT NULL

UNION ALL

-- 6) Industry group DSO 75
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'industry_group_dso_75' AS characteristics_type,
    industry_group_dso_75 AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE industry_group_dso_75 IS NOT NULL

UNION ALL

-- 7) Credit Rating Moody
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'Credit_Rating_Provider_Date' AS characteristics_type,
    CONCAT(vendor_credit_rating_moody, ';', CAST(current_date AS VARCHAR), ';moody') AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE vendor_credit_rating_moody IS NOT NULL

UNION ALL

-- 8) Credit Rating S&P
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'Credit_Rating_Provider_Date' AS characteristics_type,
    CONCAT(vendor_credit_rating_sp, ';', CAST(current_date AS VARCHAR), ';sp') AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE vendor_credit_rating_sp IS NOT NULL

UNION ALL

-- 9) Credit Revolver Rate
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'vendor_credit_revolver_rate' AS characteristics_type,
    vendor_credit_revolver_rate AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE vendor_credit_revolver_rate IS NOT NULL

UNION ALL

-- 10) Vendor COGS
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'vendor_cogs' AS characteristics_type,
    vendor_cogs AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE vendor_cogs IS NOT NULL

UNION ALL

-- 11) Indicator VC Campaign (Y/N)
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'ind_vc_campaign' AS characteristics_type,
    CASE WHEN ind_vc_campaign = 'Y' THEN 'Y' ELSE 'N' END AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE ind_vc_campaign IS NOT NULL

UNION ALL

-- 12) Virtual Card Acceptance Tier Legacy
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    virtualcard_accpetance_tier_legacy AS characteristics_type,
    'virtualcard_accpetance_tier_legacy' AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE virtualcard_accpetance_tier_legacy IS NOT NULL

UNION ALL

-- 13) Virtual Card Acceptance Tier Model
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    virtualcard_accpetance_tier_model AS characteristics_type,
    'virtualcard_accpetance_tier_model' AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE virtualcard_accpetance_tier_model IS NOT NULL

UNION ALL

-- 14) Virtual Card Acceptance Tier User Defined
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    virtualcard_accpetance_tier_userdefined AS characteristics_type,
    'virtualcard_accpetance_tier_userdefined' AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE virtualcard_accpetance_tier_userdefined IS NOT NULL

UNION ALL

-- 15) Virtual Card Campaign Count
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    ind_virtual_card_campaign_count AS characteristics_type,
    'ind_virtual_card_campaign_count' AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE ind_virtual_card_campaign_count IS NOT NULL

UNION ALL

-- 16) VC Campaign Accepts
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    vc_campaign_accepts AS characteristics_type,
    'vc_campaign_accepts' AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE vc_campaign_accepts IS NOT NULL

UNION ALL

-- 17) Registered Agents - Split JSON array into multiple rows
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    json_array_elements_text(CAST(registered_agents AS json)) AS characteristics_type,
    'registered_agent' AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM entity_id_mapping
WHERE registered_agents IS NOT NULL
AND registered_agents != '[]'
AND registered_agents != 'null'

UNION ALL

-- 18) Buying Entity Type
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'entity_type' AS characteristics_type,
    'buying_entity' AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM buying_entity_mappings

UNION ALL

-- 19) JP Morgan Chase Entity Type
SELECT
    uuid_generate_v4() AS characteristics_id,
    stg_business_entity_id,
    'entity_type' AS characteristics_type,
    'financial_institution' AS characteristic_value,
    CAST('Y' AS BOOLEAN) AS is_active,
    CAST(NULL AS VARCHAR) AS last_updated_by,
    CAST(NULL AS TIMESTAMP) AS last_updated_date,
    CAST('supplier_directory' AS VARCHAR) AS created_by,
    CAST(current_timestamp AS TIMESTAMP) AS created_date,
    CAST(NULL AS VARCHAR) AS business_validation_reason
FROM jpmc_mapping;

"stg_business_entity_id","card_revenue__end_date","card_revenue__date_accessible","card_revenue__1m__start_date","card_revenue__1m__average_monthly_amount","card_revenue__3m__start_date","card_revenue__3m__average_monthly_amount","card_revenue__12m__start_date","card_revenue__12m__average_monthly_amount","card_transactions_stability__end_date","card_transactions_stability__date_accessible","card_transactions_stability__1m__start_date","card_transactions_stability__1m__days_present","card_transactions_stability__1m__weeks_present","card_transactions_stability__1m__months_present","card_transactions_stability__1m__daily_coverage_ratio","card_transactions_stability__1m__weekly_coverage_ratio","card_transactions_stability__1m__monthly_coverage_ratio","card_transactions_stability__3m__start_date","card_transactions_stability__3m__days_present","card_transactions_stability__3m__weeks_present","card_transactions_stability__3m__months_present","card_transactions_stability__3m__daily_coverage_ratio","card_transactions_stability__3m__weekly_coverage_ratio","card_transactions_stability__3m__monthly_coverage_ratio","card_transactions_stability__12m__start_date","card_transactions_stability__12m__days_present","card_transactions_stability__12m__weeks_present","card_transactions_stability__12m__months_present","card_transactions_stability__12m__daily_coverage_ratio","card_transactions_stability__12m__weekly_coverage_ratio","card_transactions_stability__12m__monthly_coverage_ratio","associated_people__name","associated_people__titles","industries__classification_type","industries__classification_code","industries__classification_description","technologies__vendor_name","technologies__category","registered_agents"
"f6eafacb-6bcd-76ff-644d-2f027d06a021","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"aea46355-e5a3-7532-7166-db305204c727","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"3032d8ee-75e6-bb26-666b-b44e2eea9222","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"9473d9ee-c8f9-ea4a-86c7-5cf274e98be7","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"ac187673-a46f-ec90-4276-85977a1ad7b0","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"560905df-78bf-4d2a-0003-cb0a8278f87e","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","enigma_description","","family law attorney","","",""
"4c0a5662-800f-e143-69ca-83b549e17034","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"3a17e69d-a228-1401-a350-834e9f724cdd","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","CHRISTOPHER RACK","MANAGER","","","","","","UNITED STATES CORPORATION AGENTS INC"
"8dca24b9-a170-d034-1335-90079a7df227","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"4bfebc24-1591-12ba-5eb5-108d8dfc0e68","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"37afad66-7446-f810-2624-7b635463d99a","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"fff5a25d-e3b0-cc08-558a-1a71ce926f25","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"ac9b8218-33c4-ca50-ef99-b2d14a65d94f","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""
"f19ef224-1d6a-8039-fdf4-ad14aebb150c","2025-03-31","2025-06-15","","","","","","","2025-03-31","2025-06-15","2025-03-01","0","0","0","0.0","0.0","0.0","","","","","","","","","","","","","","","","","enigma_description","","law firm","","",""






from pyspark.sql.functions import col

def combine_flattened_results(base_df, flattened_dfs, join_key="stg_business_entity_id"):
    """
    Combine all flattened DataFrames back to base DataFrame using LEFT JOIN 
    but filter out rows with no actual data.
    """
    result_df = base_df.select(join_key).distinct()
    
    for df_name, df in flattened_dfs.items():
        if df.count() > 0:
            print(f"Joining {df_name}...")
            result_df = result_df.join(df, on=join_key, how="left")
        else:
            print(f"Skipping {df_name} - no data to join")
    
    # Identify non-key columns
    non_key_cols = [c for c in result_df.columns if c != join_key]
    
    # Filter out rows where all other columns are NULL or empty
    condition = None
    for c in non_key_cols:
        col_cond = (
            col(c).isNotNull() &
            (col(c) != "") &
            (col(c) != "[]") &
            (col(c) != "{}")
        )
        condition = col_cond if condition is None else (condition | col_cond)
    
    if condition is not None:
        result_df = result_df.filter(condition)
    
    return result_df


"stg_business_entity_id","card_revenue__end_date","card_revenue__date_accessible","card_revenue__1m__start_date","card_revenue__1m__average_monthly_amount","card_revenue__3m__start_date","card_revenue__3m__average_monthly_amount","card_revenue__12m__start_date","card_revenue__12m__average_monthly_amount","card_transactions_stability__end_date","card_transactions_stability__date_accessible","card_transactions_stability__1m__start_date","card_transactions_stability__1m__days_present","card_transactions_stability__1m__weeks_present","card_transactions_stability__1m__months_present","card_transactions_stability__1m__daily_coverage_ratio","card_transactions_stability__1m__weekly_coverage_ratio","card_transactions_stability__1m__monthly_coverage_ratio","card_transactions_stability__3m__start_date","card_transactions_stability__3m__days_present","card_transactions_stability__3m__weeks_present","card_transactions_stability__3m__months_present","card_transactions_stability__3m__daily_coverage_ratio","card_transactions_stability__3m__weekly_coverage_ratio","card_transactions_stability__3m__monthly_coverage_ratio","card_transactions_stability__12m__start_date","card_transactions_stability__12m__days_present","card_transactions_stability__12m__weeks_present","card_transactions_stability__12m__months_present","card_transactions_stability__12m__daily_coverage_ratio","card_transactions_stability__12m__weekly_coverage_ratio","card_transactions_stability__12m__monthly_coverage_ratio","associated_people__name","associated_people__titles","industries__classification_type","industries__classification_code","industries__classification_description","technologies__vendor_name","technologies__category","registered_agents"
"560905df-78bf-4d2a-0003-cb0a8278f87e","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","enigma_description","","family law attorney","","",""
"3a17e69d-a228-1401-a350-834e9f724cdd","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","CHRISTOPHER RACK","MANAGER","","","","","","UNITED STATES CORPORATION AGENTS INC"
"f19ef224-1d6a-8039-fdf4-ad14aebb150c","2025-03-31","2025-06-15","","","","","","","2025-03-31","2025-06-15","2025-03-01","0","0","0","0.0","0.0","0.0","","","","","","","","","","","","","","","","","enigma_description","","law firm","","",""
"1a34d721-7bf5-8eb8-695b-0c7f4d5f6f14","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","enigma_description","","legal services","","","RODRIGUEZ-MCCLOSKEY PLLC"
"1a34d721-7bf5-8eb8-695b-0c7f4d5f6f14","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","enigma_description","","legal services","","","RODRIGUEZ-MCCLOSKEY PLLC"
"1a34d721-7bf5-8eb8-695b-0c7f4d5f6f14","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","enigma_description","","legal services","","","RODRIGUEZ-MCCLOSKEY PLLC"
"1a34d721-7bf5-8eb8-695b-0c7f4d5f6f14","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","enigma_description","","legal services","","","RODRIGUEZ-MCCLOSKEY PLLC"
"5addda9a-36e5-91c7-7620-a5860bd8685f","2025-03-31","2025-06-15","","","","","","","2025-03-31","2025-06-15","2025-03-01","0","0","0","0.0","0.0","0.0","","","","","","","","","","","","","","","MATTHEW PASS","OFFICER","enigma_description","","corporate office","Shopify","payments","C T CORPORATION SYSTEM;825 8TH AVENUE"

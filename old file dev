Workspace issues and destroying resources
Deleting non-empty Terraform workspace has already been restricted. User would have to clean up the resources through terraform destroy.
In rare scenarios, you can get into a position where terraform destroy can't complete due to resource conflicts or workspace issues.
There are also cases where the workspace was abandoned or the whereabout of the code that provisioned the resources is not known.
This procedure provides a way to delete the workspace and corresponding resources provisioned with it.

Before you proceed...
Note: The procedure includes applying an "empty" main.tf file i.e. there are no resources or modules defined except jpm-data. Applying this will result to an attempt to destroy resources that is in Terraform workspace state. To validate the actions prior to destroy, you could swap the 'destroy' above with a 'plan' instead.

Below is the step-by-step guidance to be followed:
1. Extract the files from jpm-data.zip template and update the value of aws_account_id in variables/local.tfvars file.
2. The main.tf file that is included in jpm-data.zip will default to latest version. User should replace the jpm-data version in the main.tf file with the jpm-data version that is in-use in user workspace to be destroyed. User can find the jpm-data version in use by running the command tfl state show|grep terraform/modules/jpm_data once they are logged in. Refer to next steps 3 and 4 for guidance on how to login with the appropriate role.
3. User executes pcl aws login --region <AWS region> to login to their AWS account with tfe-module-pave role.
4. User executes tfl configure --org=<TFE org> --workspace=<TFE workspace> --aws-region=<AWS region>.
5. User executes tfl apply targeting the TFE workspace that needs to be cleaned up. This will clean up all modules and resources in the TFE workspace since there is only jpm_data module in the project which doesn’t provision AWS resources.
6. In case tfl apply failed due to resource conflict where there are existing resource in AWS account, user to clean up resource in conflict using ORCA and do a tfl apply after that.
7. User executes tfl destroy to destroy the jpm_data module. This step is needed because the user can’t delete the TFE workspace even if the workspace only consists of the jpm_data module.
8. User deletes the TFE workspace from the TFE UI or by executing tfl workspace delete <TFE workspace>.

User must have Workspace Write permission in order to perform this operation / Unable to create workspace
Check if the group exists AD Domain (AD.JPMORGANCHASE.COM) - https://ars7.jpmchase.net/admin/
Dev

TFE-GOLD-<seal_id>-<deployment_id>-DEV-WSCREATOR

Test

TFE-GOLD-<seal_id>-<deployment_id>-TEST-WSCREATOR

Prod

TFE-GOLD-<seal_id>-<deployment_id>-PRD-WSCREATOR


Check if your FID is part of the following - https://ars7.jpmchase.net/admin/
DEV FID

Your Dev build FID should be a member of:
TFE-GOLD-<seal_id>-<deployment_id>-DEV-WSCREATOR
AWS-<dev_aws_account_id>-tfe-module-pave
TFE-GOLD-ATLAS-MODULE-REGISTRY-READ

TEST FID

Your TEST build FID should be a member of:
TFE-GOLD-<seal_id>-<deployment_id>-TEST-WSCREATOR
AWS-<test_aws_account_id>-tfe-module-pave
TFE-GOLD-ATLAS-MODULE-REGISTRY-READ

PROD FID - Should be under EPV control

Your PROD test FID should be a member of:
TFE-GOLD-<seal_id>-<deployment_id>-PRD-WSCREATOR
AWS-<prod_aws_account_id>-tfe-module-pave
TFE-GOLD-ATLAS-MODULE-REGISTRY-READ

AWS account has resources that were created by teammates who have left the firm. Team is not aware about the workspaces used by them to provision the resources.
How to clean up / destroy those resources?

Search for the account at go/atlas-lookup
Navigate to section "Terraform Provisioned Product Versions"
Check the Workspace name under TFE_WORKSPACE_NAME for resources that need to be destroyed.NOTE It should not be UNKNOWN.
Navigate to go/tfeui,choose your organization to see if that workspace exists.
If workspace exists:
Leverage this doc to delete ALL resources provisioned using above workspace.
If workspace does not exist or is UNKNOWN, use ORCA to delete the orphan resources.
How to Unlock Terraform Workspace?
If your workspace is locked, you would see an alert on your workspaces list that says "Needs Attention" Locked Workspace Alert!

You woudl be able to see a padlock sign , indicating a locked workspace. Locked Workspace Padlock!

NOTE If a workspace is locked, your plans will queue forever.

To unlock , please follow below steps:

Navigate to go/tfeui
Select your organization
Select your workspace name
Navigate to Settings ->Locking and Unlock your workspace
See Terraform Access for more information on access requests.

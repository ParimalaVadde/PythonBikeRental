SELECT t1.*, CAST( SHA2( CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ), 256 ) AS STRING ) AS ROW_KEY, CAST( SHA2( CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ), 256 ) AS STRING ) AS MATERIALMSTR_PLANT_KEY, CONCAT_WS( '-', COALESCE(t1.SRC_SYS_CD, ''), COALESCE(CAST(t1.MAT_SHORT_ID AS STRING), ''), COALESCE(CAST(t1.PLANT_ID AS STRING), '') ) AS BUSINESS_KEY, MD5( CAST( Concat_ws( '-', COALESCE(CAST(t1.SLS_PROD_CATG_10_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_7_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_9_CD AS STRING), '*~+'), COALESCE(CAST(t1.CMDTY_CLASS_CD AS STRING), '*~+'), COALESCE(CAST(t1.CMDTY_SUB_CLASS_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_ITEM_DIM_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_1_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_2_CD AS STRING), '*~+'), COALESCE(CAST(t1.GROUP_WH_PROC_3_CD AS STRING), '*~+'), COALESCE(CAST(t1.MSTR_PLAN_FAMILY_CD AS STRING), '*~+'), COALESCE(CAST(t1.MAT_ID AS STRING), '*~+'), COALESCE(CAST(t1.MAT_POOL_CD AS STRING), '*~+'), COALESCE(CAST(t1.MRP_CTRL_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_3_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_4_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_5_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_1_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_2_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_6_CD AS STRING), '*~+'), COALESCE(CAST(t1.SLS_PROD_CATG_8_CD AS STRING), '*~+'), COALESCE(CAST(t1.STD_UOM_CONVERSION_NM AS STRING), '*~+'), COALESCE(CAST(t1.STOCK_TYPE_CD AS STRING), '*~+'), COALESCE(CAST(t1.SUPPLIER_REBATE_CD AS STRING), '*~+'), COALESCE(CAST(t1.POTENCY_DESC AS STRING), '*~+'), COALESCE(CAST(t1.MRP_CTRL_DESC AS STRING), '*~+'), COALESCE(CAST(t1.MFG_LT_VAL AS STRING), '*~+'), COALESCE(CAST(t1.ORD_POLICY_VAL AS STRING), '*~+'), COALESCE(CAST(t1.ACCT_COST_QTY AS STRING), '*~+'), COALESCE(CAST(t1.ACTIVE_FLAG AS STRING), '*~+') ) AS BINARY ) ) AS MD5_KEY FROM ( SELECT DISTINCT 'JDE_C3ME' AS SRC_SYS_CD, cast(NULL AS STRING) AS SITE_NM, cast(NULL AS STRING) AS ABC_FLG, cast(NULL AS STRING) AS BASE_UOM_NM, cast(NULL AS DECIMAL(23, 3)) AS ASMBL_SCRAP_PCT_VAL, cast(NULL AS DECIMAL(23, 3)) AS TOTAL_LT_VAL, cast(NULL AS STRING) AS PROCUREMENT_TYPE_CD, cast(NULL AS STRING) AS VALUATION_CLASS_DESC, cast(NULL AS STRING) AS VALUATION_CLASS_VAL, cast(NULL AS DECIMAL(23, 3)) AS BATCH_SIZE_MAX_VAL, cast(NULL AS DECIMAL(23, 3)) AS BATCH_SIZE_MIN_VAL, cast(NULL AS DECIMAL(23, 3)) AS ROUND_VAL, cast(NULL AS STRING) AS DOSAGE_FORM_CD, cast(NULL AS STRING) AS MAT_TYPE_CLUSTER_CD, cast(NULL AS STRING) AS NORD_MAT_ID, cast(NULL AS STRING) AS PROCURING_PLANT_ID, cast(NULL AS STRING) AS REPLN_PLANT_ID, cast(NULL AS STRING) AS REPLN_ENTITY_CD, cast(NULL AS STRING) AS REPLICATION_FLG, cast(NULL AS STRING) AS PROCURING_ENTITY_CD, cast(NULL AS STRING) AS PROCURING_REGION_CD, cast(NULL AS STRING) AS PROCURING_AREA_CD, cast(NULL AS STRING) AS REPLN_REGION_CD, cast(NULL AS STRING) AS REPLN_AREA_CD, cast(NULL AS STRING) AS REGION_NM, cast(NULL AS STRING) AS MRP_GROUP_CD, cast(NULL AS STRING) AS PROD_PLAN_PLANT_ID, cast(NULL AS STRING) AS SUPPLY_MODEL_CATG, cast(NULL AS STRING) AS CTRY_ORIGIN_CD, cast(NULL AS STRING) AS LOT_SIZE_KEY_CD, cast(NULL AS DECIMAL(23, 3)) AS SAFETY_STOCK_MIN_VAL, cast(NULL AS STRING) AS SCHED_MRGN_FLOAT_KEY_CD, cast(NULL AS STRING) AS PLAN_TIME_FENCE_VAL, cast(NULL AS DECIMAL(23, 3)) AS SAFETY_STOCK_VAL, cast(NULL AS STRING) AS ISSUE_STORAGE_LOCATION_CD, cast(NULL AS DECIMAL(23, 3)) AS SERVICE_LVL_VAL, cast(NULL AS STRING) AS SOURCING_PLANT_SUPPLIER_CD, cast(NULL AS STRING) AS LONG_TXT_DESC, cast(NULL AS DECIMAL(23, 3)) AS STOCK_LEVEL_MAX_VAL, cast(NULL AS DECIMAL(23, 3)) AS SHELF_LIFE_REMAINING_MIN_VAL, cast(NULL AS DECIMAL(23, 3)) AS REORDER_POINT_VAL, cast(NULL AS STRING) AS PLANT_SPECIFIC_MAT_STAT_CD, cast(NULL AS STRING) AS PLANT_NM, cast(NULL AS STRING) AS COVERAGE_PROF_CD, cast(NULL AS STRING) AS SAFETY_TIME_FLG, cast(NULL AS BIGINT) AS SAFETY_TIME_VAL, cast(NULL AS STRING) AS PROCUREMENT_SERIAL_TYPE_CD, cast(NULL AS STRING) AS CMDTY_FT_IMPORT_NUM, cast(NULL AS STRING) AS QUOTA_ARGMT_USE_VAL, cast(NULL AS STRING) AS PROD_PLAN_PLANT_2_ID, cast(F4102.IBSRP0 AS STRING) AS SLS_PROD_CATG_10_CD, cast(F4102.IBSRP7 AS STRING) AS SLS_PROD_CATG_7_CD, cast(F4102.IBSRP9 AS STRING) AS SLS_PROD_CATG_9_CD, cast(NULL AS STRING) AS CTRL_AREA_CD, cast(F4102.IBPRP1 AS STRING) AS CMDTY_CLASS_CD, cast(F4102.IBPRP2 AS STRING) AS CMDTY_SUB_CLASS_CD, cast(NULL AS STRING) AS DEL_FLG, cast(NULL AS STRING) AS MRP_TYPE_CD, cast(NULL AS DECIMAL(23, 3)) AS GR_PROC_TIME_VAL, cast(F4102.IBPRP6 AS STRING) AS GROUP_ITEM_DIM_CD, cast(F4102.IBPRP7 AS STRING) AS GROUP_WH_PROC_1_CD, cast(F4102.IBPRP8 AS STRING) AS GROUP_WH_PROC_2_CD, cast(F4102.IBPRP9 AS STRING) AS GROUP_WH_PROC_3_CD, cast(NULL AS DECIMAL(23, 3)) AS IN_HOUSE_PROD_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS LOT_SIZE_VAL, cast(F4102.IBPRP4 AS STRING) AS MSTR_PLAN_FAMILY_CD, cast(F4102.IBLITM AS STRING) AS MAT_ID, cast(F4102.IBPRP0 AS STRING) AS MAT_POOL_CD, cast(F4102.IBITM AS DECIMAL(38, 0)) AS MAT_SHORT_ID, cast(F4102.IBANPL AS STRING) AS MRP_CTRL_CD, cast(NULL AS STRING) AS MAT_FREIGHT_GROUP_NM, cast(F4102.IBMCU AS STRING) AS PLANT_ID, cast(NULL AS DECIMAL(23, 3)) AS PLND_DELIVERY_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS PROC_TIME_VAL, cast(NULL AS STRING) AS PROD_SCHED_CD, cast(NULL AS STRING) AS PROFIT_CENTER_CD, cast(NULL AS STRING) AS PURCHASING_GROUP_CD, cast(NULL AS DECIMAL(23, 3)) AS TOTAL_REPLN_LT_VAL, cast(NULL AS STRING) AS RUNOUT_DT, cast(F4102.IBSRP3 AS STRING) AS SLS_PROD_CATG_3_CD, cast(F4102.IBSRP4 AS STRING) AS SLS_PROD_CATG_4_CD, cast(F4102.IBSRP5 AS STRING) AS SLS_PROD_CATG_5_CD, cast(F4102.IBSRP1 AS STRING) AS SLS_PROD_CATG_1_CD, cast(F4102.IBSRP2 AS STRING) AS SLS_PROD_CATG_2_CD, cast(F4102.IBSRP6 AS STRING) AS SLS_PROD_CATG_6_CD, cast(F4102.IBSRP8 AS STRING) AS SLS_PROD_CATG_8_CD, cast(NULL AS DECIMAL(23, 3)) AS SETUP_TIME_VAL, cast(NULL AS DECIMAL(23, 3)) AS SHIP_PROC_TIME_VAL, cast(F4102.IBTFLA AS STRING) AS STD_UOM_CONVERSION_NM, cast(NULL AS STRING) AS MAX_STORAGE_PERIOD_UNIT_NM, cast(NULL AS DECIMAL(23, 3)) AS MAX_STORAGE_PERIOD_VAL, cast(F4102.IBSTKT AS STRING) AS STOCK_TYPE_CD, cast(F4102.IBPRP3 AS STRING) AS SUPPLIER_REBATE_CD, cast(NULL AS DECIMAL(23, 3)) AS INTEROPS_TIME_VAL, cast( CONCAT(TRIM(F0005.DRDL01), F0005.DRDL02) AS STRING ) AS POTENCY_DESC, cast(F0101.ABALPH AS STRING) AS MRP_CTRL_DESC, cast(F4102.IBLTLV AS decimal(38, 0)) AS MFG_LT_VAL, cast(F4102.IBOPV AS decimal(38, 0)) AS ORD_POLICY_VAL, cast(F4102.IBACQ AS decimal(38, 0)) AS ACCT_COST_QTY, cast(F4102.AUD_FILE_NM AS string) AS AUD_FILE_NM, cast(F4102.AUD_LD_DTS AS TIMESTAMP) AS AUD_LD_DTS, cast(F4102.AUD_UPD_DTS AS TIMESTAMP) AS AUD_UPD_DTS, cast('CDF_STREAMING' AS string) AS AUD_LD_USR_ID, cast(F4102.AUD_LD_BTCH_ID AS BIGINT) AS AUD_LD_BTCH_ID, cast('JDE_C3ME' AS string) AS AUD_SRC_SYS_ID, cast(F4102.ACTIVE_FLAG AS string) AS ACTIVE_FLAG FROM ( SELECT * FROM ( SELECT *, row_number() OVER ( PARTITION BY IBMCU, IBITM ORDER BY aud_upd_dts, aud_ld_dts DESC ) AS row_num FROM gms_us_lake.gmsgq_jde_proddta_f4102_adt ) WHERE row_num = 1 ) F4102 LEFT OUTER JOIN ( SELECT * FROM ( SELECT DRKY, DRSY, DRRT, CASE WHEN ACTIVE_FLAG = 'N' THEN NULL ELSE DRDL01 END AS DRDL01, CASE WHEN ACTIVE_FLAG = 'N' THEN NULL ELSE DRDL02 END AS DRDL02, AUD_UPD_DTS, AUD_LD_DTS, row_number() OVER ( PARTITION BY DRSY, DRRT, DRKY ORDER BY aud_upd_dts, aud_ld_dts DESC ) AS row_num FROM gms_us_lake.gmsgq_jde_prodctl_f0005 WHERE TRIM(DRRT) = 'S5' AND TRIM(DRSY) = '41' ) WHERE row_num = 1 ) F0005 ON TRIM(F4102.IBSRP5) = TRIM(F0005.DRKY) LEFT OUTER JOIN ( select * from ( SELECT ABAN8, CASE WHEN ACTIVE_FLAG = 'N' THEN NULL ELSE ABALPH END AS ABALPH, aud_upd_dts, aud_ld_dts, row_number() OVER ( PARTITION BY ABAN8, ABALPH ORDER BY aud_upd_dts, aud_ld_dts DESC ) AS row_num FROM gms_us_lake.gmsgq_jde_proddta_f0101_adt ) WHERE row_num = 1 ) F0101 ON TRIM(F4102.IBANPL) = TRIM(F0101.ABAN8) WHERE greatest( coalesce( F0005.AUD_UPD_DTS, F0005.AUD_LD_DTS, CAST('1100-12-12 11:59:59' AS TIMESTAMP) ), coalesce( F0101.AUD_UPD_DTS, F0101.AUD_LD_DTS, CAST('1100-12-12 11:59:59' AS TIMESTAMP) ) ) >= ( SELECT coalesce( batch_last_run_time, CAST('1900-01-01 00:00:00' AS TIMESTAMP) ) TS FROM gms_us_hub.gmsgq_laketohub_batch_job_log WHERE lower(tgt_tbl) = 'gms_us_hub.ref_materialmstr_plant_erp_glbl' AND src_system = 'JDE_C3ME' AND lower(src_tbl) = 'gms_us_lake.gmsgq_jde_proddta_f4102_adt' ) ) t1
